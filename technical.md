# 배포를 위한 도커 컴포즈 살펴보기

---

## 1. 소개

### 배포 프로세스의 중요성

우리 프로젝트의 인프라 구조는 매번 변했으며, 특히 배포 프로세스는 요구사항에 따라 지속적으로 진화해야 했습니다. 저희는 초기에는 리눅스 쉘 스크립트를 사용하여 배포했지만, 여러 문제를 해결하기 위해 도커 컴포즈를 도입하게 되었습니다.

### 전통적인 쉘스크립트 배포의 특징과 한계점

초기에는 간단한 쉘 스크립트를 통해 개발 서버에 서비스를 띄웠습니다. 예시로, 저희는 자바 설치, 빌드, 서버 실행을 자동화하는 스크립트를 사용했습니다. 그러나 쉘스크립트는 운영체제별로 설정 방법이 다르고, 유지보수가 어렵다는 한계가 있었습니다.

### 도커 컴포즈 도입의 필요성

이러한 한계점을 극복하고 배포 프로세스를 효율화하기 위해 도커 컴포즈를 도입했습니다. 도커 컴포즈는 환경 간 일관성을 유지하며 배포를 자동화할 수 있는 강력한 도구입니다.

## 2. 기본 개념 이해하기

### 도커 컴포즈란 무엇인가?

도커 컴포즈는 멀티컨테이너 도커 애플리케이션을 정의하고 실행하는 도구입니다. `docker-compose.yml` 파일을 사용해 애플리케이션의 서비스, 네트워크, 볼륨 등을 정의할 수 있습니다.

### 주요 개념: 서비스, 네트워크, 볼륨

- **서비스**: 애플리케이션의 개별 컨테이너를 의미하며, 여러 개의 서비스를 정의해 애플리케이션을 구성할 수 있습니다.
- **네트워크**: 도커 컴포즈는 서비스 간 통신을 위한 네트워크를 자동으로 설정해줍니다. 이를 통해 컨테이너들이 서로 통신할 수 있습니다.
- **볼륨**: 데이터를 영구적으로 저장하거나 공유하기 위해 사용되는 저장소입니다.

### 도커 컴포즈와 도커의 차이점

도커는 개별 컨테이너를 실행하고 관리하는 도구이고, 도커 컴포즈는 여러 개의 컨테이너를 하나의 애플리케이션으로 관리할 수 있는 도구입니다. 도커 컴포즈를 통해 복잡한 멀티컨테이너 애플리케이션을 쉽게 관리할 수 있습니다.

## 3. 쉘스크립트 배포 프로세스 개요

### 기존 쉘스크립트 배포 흐름

기존에는 다음과 같은 쉘 스크립트를 사용하여 서버에 애플리케이션을 배포했습니다.

```shell
# 자바 설치
wget -O- https://apt.corretto.aws/corretto.key | sudo apt-key add -
sudo add-apt-repository 'deb https://apt.corretto.aws stable main'
sudo apt-get update; sudo apt-get install -y java-17-amazon-corretto-jdk

# 빌드
git clone https://github.com/woowacourse/spring-roomescape-payment.git
cd spring-roomescape-payment
./gradlew bootJar

# 서버 실행
cd build/libs
java -jar spring-roomescape-payment-0.0.1-SNAPSHOT.jar
nohup java -jar spring-roomescape-payment-0.0.1-SNAPSHOT.jar &
```

운영체제마다 설치 방법이 다르고, 환경 설정이 복잡해지면 유지보수가 어려워진다는 단점이 있습니다. 또한, 다음과 같은 문제들이 있습니다:

- **운영체제 종속성**: 스크립트가 특정 운영체제에 맞춰 작성되므로, 다른 운영체제에서 실행할 때는 호환성 문제가 발생할 수 있습니다. 예를 들어, 우분투에서는 APT를 사용하지만 CentOS에서는 YUM을 사용해야 합니다.
- **오류 처리의 어려움**: 쉘스크립트는 오류가 발생했을 때 이를 포괄적으로 처리하기 어렵습니다. 각 명령어의 성공 여부를 일일이 확인하고 처리해야 하기 때문에, 복잡한 스크립트에서는 오류가 발생해도 원인을 파악하기 어려운 경우가 많습니다.
- **확장성 부족**: 여러 서버에 동일한 설정을 적용해야 할 때, 모든 서버에서 스크립트를 수동으로 실행해야 하는 번거로움이 있습니다. 이는 서버 수가 많아질수록 작업량이 기하급수적으로 증가하고, 사람이 개입하는 과정에서 실수가 발생할 가능성도 높아집니다.
- **환경 일관성 문제**: 개발, 테스트, 운영 환경 간에 동일한 설정을 유지하기 어렵습니다. 환경별로 필요한 설정을 일관되게 관리하기가 어려워, 환경 간 차이로 인해 발생하는 문제가 생길 수 있습니다.

### 전환을 고려하게 된 이유

여러 개의 서버에 동일한 설정을 적용하고, 환경 설정을 일관되게 유지하기 위해 도커 컴포즈로의 전환을 고려하게 되었습니다.

## 4. 도커 컴포즈 배포 프로세스 전환 준비

의존성을 확인한 결과, 다음과 같은 요소들이 도커 컴포즈 전환에 중요한 영향을 미쳤습니다:

- **자바 설치 의존성**: 기존에 사용되었던 Amazon Corretto 자바 17을 도커 이미지로 대체해야 했습니다. 이를 위해 Amazon Corretto의 공식 이미지를 도커 컴포즈 설정에서 사용하도록 변경했습니다.
- **Nginx 설정**: Nginx는 기존에 수동으로 설치 및 설정하였으나, 도커 컴포즈를 통해 이미지로 전환하여 설정 파일을 도커 볼륨으로 연결해 관리할 수 있도록 변경했습니다.
- **환경 변수 및 설정 파일**: 기존의 배포 과정에서 환경 변수는 서버별로 수동 설정했으나, 도커 컴포즈에서는 `.env` 파일을 사용해 일관되게 관리할 수 있도록 하였습니다. 이를 통해 환경별 설정의 일관성을 유지할 수 있게 되었습니다.

### 도커 컴포즈로 전환 시 필요한 요구 사항 및 준비물

- **도커 설치**: 도커 컴포즈를 사용하려면 서버에 도커와 도커 컴포즈가 설치되어 있어야 합니다.
- **이미지 준비**: 애플리케이션을 실행할 도커 이미지를 미리 빌드하거나, 도커 허브에서 필요한 이미지를 가져와야 합니다.

### 프로젝트 구조 및 구성 파일 설정

- 기본적으로는 다음과 같은 `.env` 파일을 사용할 수 있습니다:

```
DB_HOST=database.example.com
DB_USER=admin
DB_PASSWORD=secret
SPRING_PROFILES_ACTIVE=prod
```

이 `.env` 파일은 데이터베이스 연결 정보나 스프링 프로파일과 같은 환경 변수를 정의합니다. 이를 `docker-compose.yml` 파일에서 참조하면, 환경에 맞게 설정을 쉽게 변경할 수 있습니다. `docker-compose.yml` 파일에서 다음과 같이 참조할 수 있습니다:

```yml
environment:
  DB_HOST: ${DB_HOST}
  DB_USER: ${DB_USER}
  DB_PASSWORD: ${DB_PASSWORD}
  SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
```

이렇게 하면 `.env` 파일에 정의된 값을 사용하여 환경 변수를 설정할 수 있으며, 환경별로 다른 설정을 쉽게 적용할 수 있습니다.

- **docker-compose.yml 파일**: 각 서비스, 네트워크, 볼륨 등의 설정을 정의합니다.

## 5. 도커 컴포즈 파일 작성 및 설정하기

### `docker-compose.yml` 파일 작성 방법

`docker-compose.yml` 파일은 애플리케이션의 전체 구조를 정의하는 파일로, 각 서비스와 네트워크, 볼륨 등을 설정합니다.

### 서비스 정의 및 네트워크 구성

```yml
services:
  spring:
    image: amazoncorretto:17
    container_name: spring
    expose:
      - 8080
    environment:
      TZ: Asia/Seoul
    volumes:  # volumes를 사용해 호스트와 컨테이너 간의 파일을 공유할 수 있습니다. 예를 들어, 로그 파일이나 설정 파일을 호스트에 저장할 수 있습니다.
      - ./spring:/app
    entrypoint: # entrypoint를 사용해 컨테이너가 시작될 때 실행할 명령어를 정의합니다.
      - "java"
      - "-jar"
      - "-Dspring.config.location=/app/application-prod.yml,/app/application-db.yml,/app/application-actuator.yml,/app/application-swagger.yml"
      - "-Dspring.profiles.active=prod,db,actuator,swagger"
      - "/app/zap.jar"
```

위 설정은 컨테이너가 시작되면 자바 애플리케이션을 실행하는 명령어입니다. `-Dspring.config.location`과 `-Dspring.profiles.active` 옵션을 사용해 설정 파일의 위치와 활성화할 프로파일을 지정합니다. 이를 통해 애플리케이션이 자동으로 설정된 환경에서 실행될 수 있도록 합니다.



## 6. 배포 스크립트 전환 과정

### 기존 쉘스크립트 기능과 도커 컴포즈의 대응 관계

기존의 자바 설치, 빌드, 실행 과정을 도커 컴포즈의 이미지와 `docker-compose.yml` 설정으로 대체했습니다.

### 전환 과정에서 발생할 수 있는 이슈와 해결 방법

- **네트워크 충돌**: 기존 포트를 다른 프로세스가 사용 중일 경우 충돌이 발생할 수 있습니다. 이를 해결하기 위해 포트를 변경하거나 기존 프로세스를 종료했습니다.
- **의존성 문제**: 각 서비스 간 의존성을 설정해 도커 컴포즈가 올바른 순서로 서비스를 실행하도록 했습니다.

### 도커 컴포즈 명령어로 배포 자동화하기

- `서비스 실행: `docker compose up -d`
- 서비스 중지: `docker compose down`
- 서비스 재시작: `docker compose restart`

## 7. 도커 컴포즈 배포 프로세스 테스트 및 검증

### 단계별 테스트 절차

1. **로컬 테스트**: 로컬 환경에서 모든 서비스가 정상적으로 실행되는지 확인했습니다.
2. **스테이징 환경 테스트**: 실제 운영 환경과 유사한 스테이징 환경에서 배포 및 기능 테스트를 수행했습니다.

### 오류 디버깅 및 문제 해결

도커 로그(`docker logs {컨테이너명}`)를 사용해 오류 메시지를 확인하고 문제를 해결했습니다.

### 실제 운영 환경에서의 검증 포인트

- 각 서비스가 정상적으로 통신하는지
- SSL 인증서가 올바르게 적용되었는지

## 8. 도커 컴포즈의 확장 기능 살펴보기

### 멀티컨테이너 오케스트레이션

도커 컴포즈는 여러 개의 컨테이너를 함께 오케스트레이션하여 복잡한 애플리케이션을 쉽게 관리할 수 있습니다.

### 스케일링과 서비스 업데이트

`docker compose up --scale` 명령어를 사용해 특정 서비스를 스케일링할 수 있습니다. 이를 통해 트래픽 증가에 대응할 수 있습니다.

### 로깅 및 모니터링 활용 방안

도커의 로깅 드라이버를 사용해 각 서비스의 로그를 중앙화하거나, Prometheus와 Grafana 같은 모니터링 도구와 연계해 시스템 상태를 모니터링할 수 있습니다.

## 9. 도커 컴포즈 전환의 이점과 도전 과제

### 전환 후 장점: 효율성, 유지보수성, 확장성

- **효율성**: 설정 파일 하나로 여러 개의 컨테이너를 관리할 수 있어 효율적입니다.
- **유지보수성**: 설정이 코드로 관리되므로 변경 이력을 추적하기 쉽습니다.
- **확장성**: 스케일링이 용이하고, 여러 환경에서 일관된 배포가 가능합니다.

### 남은 과제와 향후 개선 방향

- **모니터링 강화**: 현재는 기본적인 모니터링만 가능하며, 더 세부적인 모니터링 체계를 도입할 필요가 있습니다.
- **보안 강화**: 환경 변수와 비밀 정보를 안전하게 관리하기 위한 추가적인 보안 조치가 필요합니다.

### 도커 컴포즈의 한계와 보완책

도커 컴포즈는 단일 호스트에서의 오케스트레이션에는 유용하지만, 여러 호스트에 걸친 분산 오케스트레이션에는 한계가 있습니다. 이를 보완하기 위해 Kubernetes와 같은 도구를 도입할 수 있습니다.

## 10. 결론

### 쉘스크립트에서 도커 컴포즈로 전환한 배포 프로세스 요약

기존의 쉘스크립트 기반 배포의 복잡성과 한계를 극복하기 위해 도커 컴포즈를 도입했습니다. 이를 통해 환경 설정의 일관성을 유지하고, 배포의 효율성과 안정성을 높일 수 있었습니다.

### 성공적인 전환을 위한 조언 및 팁

- **작게 시작하기**: 초기에는 소규모 프로젝트에 도커 컴포즈를 적용해 보는 것이 좋습니다.
